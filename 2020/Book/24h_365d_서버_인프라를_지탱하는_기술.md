# 24시간 365일 서버/인프라를 지탱하는 기술

## 다중화

> 장애가 발생해도 예비 운용장비로 시스템의 기능을 계속할 수 있도록 하는 것

1. 장애를 상정한다.
    - 어떤 시스템에서 발생할 수 있는 장애요소들을 정의한다.
2. 장애를 대비해서 예비 운용장비를 준비한다.
    - 각 장애에 대비해서 예비 운용장비를 도입한다.
3. 장애가 발생했을 때 예비 운용장비로 교체할 수 있도록 한다.
    - 장애가 실제로 발생했을 때 예비장비로 교체한다.

LAN의 세계에서는 IP주소가 아닌 NIC에 할당 되어 있는 MAC주소를 사용해서 통신한다. 다른 서버에 패킷을 보낼 때는 MAC주소를 얻기위해 ARP라는 프로토콜을 이용한다.

### L4스위치와 L7스위치

- L4Switch: TCP헤더 등의 프로토콜 헤더의 내용을 분석해서 분산시킬 곳을 결정 - 성능을 추구한다면 L4
- L7Switch: 애플리케이션 계층의 내부까지 분석해서 분산시킬 곳을 결정 - 유연한 설정을 하고자 한다면 L7

### 다중화 프로토콜 VRRP (Virtual Router Redundancy Protocol)

보통의 헬스체크는 주기적으로 특정요청을 보내서 응답을 확인하는 방식이다. 그러나 VRRP는 역으로 마스터 노드의 가동을 감시하는 방식으로 작동한다. 그러니까 마스터 노드에 요청을 보내는 것이 아니라, 마스터 노드가 알아서 자신이 살아 있는지를 송신한다.

VRRP의 마스터 노드는 정기적으로 VRRP 패킷을 멀티 캐스팅 주소(224.0.0.18)로 송신한다. VRRP에서는 백업 노드가 능동적으로 마스터 노드의 상태를 확인하지는 않는다.

그러면 여기서 의문점이 생기는데,

1. VRRP 패킷은 모두 멀티 캐스팅 주소로 송신된다. 그러면 여러 대의 로드밸런서가 동일 네트워크 상에 존재한다면, 이 패킷이 헷갈릴 수 있는 가능성이 존재하지 않을까?
    - 하지만 아니다. 모든 LB가 동일한 주소(224.0.0.18)로 패킷을 전송하지만, VRRP에서는 가상 라우터 ID라는 파라미터로 인스턴스를 구분한다.
2. 만약 여러 대의 백업 노드를 가진다면, Failover시에 어떤 노드가 마스터 노드가 될 것인가?
    - 각 노드마다 Priority를 설정한다.
    - Preemptive mode도 존재한다. 이는 현재 가동 중인 마스터 노드보다 priority가 높은 백업 노드가 존재하더라도, 현재 마스터 노드가 가동 중이기 때문에, 교체를 하지 않는 방식이다.

그리고 Failover시에는 MAC 주소도 함께 인계한다. 그 이유는 MAC주소를 인계하지 않는다면 이 장비와 통신하는 모든 장비의 ARP 테이블을 변경해야하는 문제점이 있기 때문이다.

### 리버스 프록시

클라이언트의 요청을 받아서 적절한 웹서버로 요청을 전송한다.

1. 웹서버는 요청을 받아서 처리 후 리버스 프록시로 보낸다.
2. 리버스 프록시는 그 응답을 클라이언트로 보낸다.

리버스 프록시를 이용하면 클라이언트의 요청이 웹서버로 전달 되는 도중의 처리에 끼어 들어 다양한 전, 후처리를 할 수 있다.

- HTTP의 요청의 내용에 따라 L7 스위치가 하는 역할과 비슷
- 시스템 전체의 메모리 사용 효율 향상
- 웹서버 응답 데이터의 버퍼링 역할

### 캐시서버

1. HTTP는 Stateless 하다.
2. 상태를 갖지 않으므로 캐싱하기 쉽다.
3. 프로토콜 레벨에서 캐시기능이 내장되어있다.

### DB Replication

데이터를 실시간으로 다른 곳으로 복제하는 것

### 스토리지 서버

- 스토리지 서버에 장애가 발생하면 피해가 광범위하게 미친다.
- 데이터가 소실 되면 복구가 힘들다.
- 병목지점이 되기 쉽다.

### VLAN

유연성이 높은 네트워크란?

1. 신규 서버를 추가하기가 쉬움
2. 장애 발생 시 대체 장비로 변경이 쉬움
3. 특정 서버를 별도의 역할을 하는 서버로 분리하기 쉬움

#### VLAN의 이점

- 한대의 스위치로 여러 세그먼트를 관리할 수 있다.
- 설정만으로 포트를 지나는 데이터를 제어할 수 있다.

#### VLAN의 기본

물리적인 구성이 아니라 네트워크 장비나 서버의 설정으로 '논리적'으로 네트워크를 분할해서 구성하는 것. VLAN을 이용하면 동일한 스위치에 여러 세그먼트의 단말을 접속해도 설정에 의해 논리적으로 브로드캐스팅 도메인을 분할할 수 있으므로 그 결과로 적절한 포트에만 프레임이 포워딩 되게 된다.

#### Port VLAN

- 스위치의 포트마다 VLAN ID를 할당
- 하나의 포트에 대해 하나의 VLAN ID 부여, 그룹핑하고자 하는 포트에 대해서는 동일한 식별자를 부여한다.

#### Tagged VLAN

- VLAN ID를 포함한 VLAN 식별정보(tag)를 이더넷 프레임에 삽입하여 각 VLAN 그룹을 식별한다.
- VLAN 태그는 이더넷 프레임이 전송될 때 삽입된다.

핵심은 VLAN을 적용하더라도 최대한 단순한 구성을 유지하는 것이다.

## 성능향상

### MySQL 튜닝의 핵심

1. 서버 측면에서의 튜닝
    - mysqld의 파라미터 튜닝
    - OS 관련된 튜닝(디스크 I/O 관련 커널 파미터 조정, 적절한 파일시스템, 마운트 옵션 등)
2. 서버 이외의 측면
    - 테이블 설계(적절한 인덱스 생성, 의도적인 비정규화)
    - SQL 최적화 (인덱스 타도록, 테이블 결합 순서 등)
3. 주변 시스템 튜닝
    - 앞단의 캐시 서버 두기
